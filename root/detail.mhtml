<%args>
$filename => undef
$terms => undef
$pos => undef
$last => undef
</%args>

<%perl>
  use File::Tagr;

  if (!defined $filename) {
    $filename = $c->req->param('filename');
  }
  if (!defined $terms) {
    $terms = $c->req->param('terms');
  }
  if (!defined $pos) {
    $pos = $c->req->param('pos');
  }
  if (!defined $last) {
    $last = $c->req->param('last');
  }
  my $tagr = new File::Tagr(config_dir => $File::Tagr::CONFIG_DIR, verbose => 0);
  my $hash = $tagr->get_hash_of_file($filename);
  if (defined $hash) {
    my $description = "";
    if (defined $hash->description_id()) {
      $description = $hash->description_id()->detail();
    }
    my $size = '640x480';
    my ($cached_image, $full) =
      File::Tagr::Cache->get_image_from_cache($hash->detail(), $filename,
                                              [$size, 'full']);
    my @tag_strings = map {$_->detail()} $hash->tags();

    my @filenames = $tagr->find_file_by_hash($hash->detail());
</%perl>

<p> <% $description %> </p>
<p> tags: <span style="font-size: 90%">
<div id="tags_text" style="display: block">
%   for my $tag (@tag_strings) {
      <a href="/action/search?terms=<% $tag %>"><% $tag %></a>
%   }
  (<a href="#" onclick="document.getElementById('tags_text').style.display = 'none'; document.getElementById('tag_edit').style.display = 'block';">edit</a>)
</div>
<div id="tag_edit" style="display: none">
  <form name="tag_edit_form" method="post" action="/action/tagedit">
    <input name="tags" size="60" value="<% join(' ', @tag_strings) %>"/>
  </form>
</div>
</span></p>

<p>
<%perl>
if ($pos != 0) {
  my $prev_pos = $pos - 1;
  my $param_str = "terms=$terms&pos=$prev_pos&last=$last";
</%perl>
  <a href="/action/search?<% $param_str %>">prev</a>
<%perl>
}
if ($pos != $last) {
  my $next_pos = $pos + 1;
  my $param_str = "terms=$terms&pos=$next_pos&last=$last";
</%perl>
  <a href="/action/search?<% $param_str %>">next</a>
<%perl>
}
</%perl>
</p>

<p> <a href='<% "/photos/cache/$full" %>'> <img src='<% "/static/cache/$cached_image" %>'/></a> </p>

<h2>File names:</h2>

<ul>
% for my $other_filename (@filenames) {
<li>
<% $other_filename %>
</li>
% }
</ul>
<a href='<% "/static/cache/$full" %>'>full size</a></p>

% } else {
<% $hash->detail() %> not found
% }
