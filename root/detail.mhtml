<%args>
$digest => undef
$hash => undef
$terms => undef
$pos => undef
$last => undef
</%args>

<%perl>
  use File::Tagr;

  if (!defined $digest) {
    $digest = $c->req->param('digest');
  }
  if (!defined $terms) {
    $terms = $c->req->param('terms');
  }
  if (!defined $pos) {
    $pos = $c->req->param('pos');
  }
  if (!defined $last) {
    $last = $c->req->param('last');
  }
  if (!defined $hash) {
    my $tagr = new File::Tagr(config_dir => $File::Tagr::CONFIG_DIR, verbose => 0);
    $hash = $tagr->find_hash($digest);
  }
  if (defined $hash) {
    my $description = "";
    if (defined $hash->description_id()) {
      $description = $hash->description_id()->detail();
    }
    my $size = '640x480';
    my ($cached_image, $full) =
      File::Tagr::Cache->get_image_from_cache($hash, [$size, 'full']);
    my @tag_strings = map {$_->detail()} map {$_->tag_id()} $hash->hashtags();
    my @files = $hash->files();
</%perl>

<p> <% $description %> </p>
<p> tags: <span style="font-size: 90%">
<div id="tags_text" style="display: block">
%   for my $tag (@tag_strings) {
      <a href="/action/search?terms=<% $tag %>"><% $tag %></a>
%   }
  (<a href="#" onclick="document.getElementById('tags_text').style.display = 'none'; document.getElementById('tag_edit').style.display = 'block';">edit</a>)
</div>
<div id="tag_edit" style="display: none">
  <form name="tag_edit_form" method="post" action="/action/tagedit">
    <input name="tags" size="60" value="<% join(' ', @tag_strings) %>"/>
  </form>
</div>
</span></p>

<p>
<table><tr>
<td align="left">
<%perl>
my $prev_str = '&lt;&lt; previous match';
if (defined $pos && $pos != 0) {
  my $prev_pos = $pos - 1;
  my $param_str = "terms=$terms&pos=$prev_pos&last=$last";
  print "<a href='/action/search?$param_str'>$prev_str</a>\n";
} else {
  print "<span style='color:grey'>$prev_str</span>\n";
}
</%perl>
</td>
<td align="right">
<%perl>
my $next_str = 'next match &gt;&gt;';
if (defined $pos && $pos != $last) {
  my $next_pos = $pos + 1;
  my $param_str = "terms=$terms&pos=$next_pos&last=$last";
  print "<a href='/action/search?$param_str'>$next_str</a>\n";
} else {
  print "<span style='color:grey'>$next_str</span>\n";
}
</%perl>
</tr>
<tr>
<td colspan="2">
<a href='<% "/photos/cache/$full" %>'> <img src='<% "/photos/cache/$cached_image" %>'/></a> </p>
</td>
</tr>
</table>

<h2>File names:</h2>

<ul>
% for my $other_file (@files) {
<li>
<% $other_file->detail() %>
</li>
% }
</ul>
<a href='<% "/static/cache/$full" %>'>full size</a></p>
% } else {
<% $digest %> not found
% }
