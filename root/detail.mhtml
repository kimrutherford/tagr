<%args>
$digest => undef
$hash => undef
$terms => undef
$year => ""
$month => ""
$day => ""
$dow => ""
$pos => undef
$last => undef
</%args>

<%perl>
  use File::Tagr;
  use File::Tagr::Web::Util;
#  use HTML::Prototype;

#  my $prototype = HTML::Prototype->new;

  if (!defined $digest) {
    $digest = $c->req->param('digest');
  }
  if (!defined $terms) {
    $terms = $c->req->param('terms');
  }
  if (!defined $pos) {
    $pos = $c->req->param('pos');
  }
  if (!defined $last) {
    $last = $c->req->param('last');
  }
  my $tagr = File::Tagr::Web->config->{tagr};
  if (!defined $hash) {
    $hash = $tagr->find_hash($digest);
  }
  if (defined $hash) {
    my $description = "";
    if (defined $hash->description_id()) {
      $description = $hash->description_id()->detail();
    }
    my $size = '640x480';
    my ($cached_image, $full) =
      $tagr->get_cache()->get_image_from_cache($hash, [$size, 'full']);
    my @tag_strings = map {$_->detail()} map {$_->tag_id()} $hash->hashtags();
    my @files = $hash->files();
</%perl>

<p> <% $description %> </p>
<p> tags: &nbsp;<span style="font-size: 90%">
<span id="tags_text" style="display: inline">
%   for my $tag (@tag_strings) {
      <a href="/action/search?terms=<% $tag %>"><% $tag %></a>
%   }
%#  (<a href="#" onclick="document.getElementById('tags_text').style.display = 'none'; document.getElementById('tag_edit').style.display = 'block';">edit</a>)
</span>
% if ($c->request->address eq '82.69.238.134') {
%#   print $prototype->in_place_editor('tags_text', {rows=>1})
% }

<span id="tag_edit" style="display: none">
  <form name="tag_edit_form" method="post" action="/action/tagedit">
    <input name="tags" size="60" value="<% join(' ', @tag_strings) %>"/>
  </form>
</span>
</span></p>

<p>
<table><tr>
<td align="left">
<%perl>
my $date_bits = File::Tagr::Web::Util->get_params_from_date_bits(%ARGS);

my $prev_str = '&lt;&lt; previous';
if (defined $pos && $pos != 0) {
  my $prev_pos = $pos - 1;
  my $param_str = "${date_bits}terms=$terms&pos=$prev_pos&last=$last";
  print "<a href='/action/search?$param_str'>$prev_str</a>\n";
} else {
  print "<span style='color:grey'>$prev_str</span>\n";
}
</%perl>
</td>
<td align="right">
<%perl>
my $next_str = 'next &gt;&gt;';
if (defined $pos && $pos != $last) {
  my $next_pos = $pos + 1;
  my $param_str = "${date_bits}terms=$terms&pos=$next_pos&last=$last";
  print "<a href='/action/search?$param_str'>$next_str</a>\n";
} else {
  print "<span style='color:grey'>$next_str</span>\n";
}
</%perl>
</tr>
<tr>
<td colspan="2">
<a href='<% "/static/cache/$full" %>'> <img src='<% "/static/cache/$cached_image" %>'/></a> </p>
</td>
</tr>
</table>

<h2>File names:</h2>

<ul>
% for my $other_file (@files) {
<li>
<% $other_file->detail() %>
</li>
% }
</ul>
<p>
<%perl>
 if (defined $hash->creation_timestamp()) {
   print "Creation date: ", $hash->creation_timestamp(), "\n";
 }
</%perl>
</p>
<a href='<% "/static/cache/$full" %>'>full size</a></p>
% } else {
<% $digest %> not found
% }
