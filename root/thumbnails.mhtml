<%args>
@hashes
$terms => ""
$year => ""
$month => ""
$day => ""
$dow => ""
$pos => 0
$count => 32
</%args>

<%perl>
use File::Tagr::Web::Util;

my $date_bits = File::Tagr::Web::Util->get_params_from_date_bits(%ARGS);

</%perl>

% if (@hashes) {
 <table width="100%">
   <tr>
     <td> Search results for tags: <% $terms eq '' ? '[none]' : $terms %> &nbsp;&nbsp;
<%perl>
 if ($year ne '') {
   print "year: $year &nbsp;&nbsp;\n";
 }
 if ($month ne '') {
   print "month: $month &nbsp;&nbsp;\n";
 }
 if ($day ne '') {
   print "day: $day &nbsp;&nbsp;\n";
 }
 if ($dow ne '') {
   print "day of week: $dow &nbsp;&nbsp;\n";
 }
</%perl>
 </td>
 <td align="center">
   results: <% scalar(@hashes) %>
 </td>
% if ($count < @hashes) {
     <td align="right">
%       print "<a href='/action/search?${date_bits}terms=$terms&count=-1'>show all</a>\n";
     </td>
% }
   </tr>
 </table>

<%perl>
  sub make_page_link
  {
    my $page = shift;
    my $count = shift;
    my $terms = shift;
    my $date_bits = shift;
    my $link_pos = ($page - 1) * $count;
    return "<a href='/action/search?${date_bits}terms=$terms&pos=$link_pos'>$page</a>";
  }

  my $size = '96x96';
  my $tagr = File::Tagr::Web->config->{tagr};
  my $start = 0;

  if ($count < 1) {
    $count = 99999999;
  }

  if (defined $pos && $pos < @hashes) {
    $start = $pos;
  }
  my $end = $pos + $count;
  if ($end > @hashes) {
    $end = @hashes;
  }

  if ($count <= @hashes) {
    print '<table width="100%"><tr>';
    print '<td align="left">';
    my $prev_str = '&lt;&lt; previous page';
    if ($start > 0) {
      my $new_pos = $start - $count;
      my $pos_str = "";
      if ($new_pos > 0) {
        $pos_str = '&pos=' . $new_pos;
      }
      print "<a href='/action/search?terms=$terms$pos_str'>$prev_str</a>";
    } else {
      print "<span style='color:grey'>$prev_str</span>";
    }
    print '</td>';

    print '<td>';
    my $max_page = int((scalar(@hashes) - 1) / $count) + 1;
    my $current_page = int($start / $count) + 1;
    my $page_start = $current_page - 6;
    my $page_end = $current_page + 6;
    if ($page_start < 3) {
      $page_start = 1;
    }
    if ($page_start > 1) {
      print make_page_link(1, $count, $terms, $date_bits), " ... ";
    }
    if ($page_end == $max_page - 1) {
      $page_end = $max_page;
    }
    if ($page_end > $max_page) {
      $page_end = $max_page;
    }
    for (my $pagei = $page_start; $pagei <= $page_end; $pagei++) {
      if ($pagei == $current_page) {
        print "$pagei ";
      } else {
        print make_page_link($pagei, $count, $terms, $date_bits), " ";
      }
    }
    if ($page_end < $max_page) {
      print "... ", make_page_link($max_page, $count, $terms, $date_bits), " ";
    }
    print '</td>';

    print '<td align="right">';
    my $next_str = 'next page &gt;&gt;';
    if ($end < @hashes - 1) {
      my $new_pos = $start + $count;
      print "<a href='/action/search?${date_bits}terms=$terms&pos=$new_pos'>$next_str</a>";
    } else {
      print "<span style='color:grey'>$next_str</span>";
    }
    print '</td>';

    print '</tr></table>';

    print '<br clear="all"/>';
  }

</%perl>

<div>
  <div id="message">
    <a href="javascript:toggleDiv('hiddenDiv1'); javascript:toggleDiv('message');"
       title="more tags">
      more tags ...
    </a>
  </div>
  <div style="display: none;" id="hiddenDiv1">
    <a href="javascript:toggleDiv('hiddenDiv1'); javascript:toggleDiv('message');"
       title="hide tags">
      hide tags
    </a>
    <& tag_cloud.mas, terms => $terms, year => $year, month => $month, day => $day, dow => $dow  &>
  </div>
</div>

<form name="tag" method="post" action="/action/add_tag">
<input type="hidden" name="terms" value="<% $terms %>">
<input type="hidden" name="start_thumb" value="<% $start %>">
<input type="hidden" name="end_thumb" value="<% $end %>">

<fieldset id="selectables_container">
  <table>
<%perl>

  for (my $i = $start; $i < $end; $i++) {
    my $hash = $hashes[$i];
    my $image_file =
      ($tagr->get_cache()->get_image_from_cache($hash, [$size]))[0];

    if (($i - $start) % 8 == 0) {
      print "<tr>\n";
    }

    if (!defined $image_file) {
      next;
    }

    my $last = @hashes - 1;
    my $digest = $hash->detail();
    my $param_str = "digest=$digest&${date_bits}terms=$terms&pos=$i&last=$last";
</%perl>

 <td>
   <span>
     <input type="checkbox" name="<% $i %>" value="<% $hash->detail() %>">
     <a href="/action/detail?<% $param_str %>">
       <img src="<% '/static/cache/' . $image_file %>"/>
     </a>
     </input>
   </span>
 </td>
<%perl>
  }
  if ($end < @hashes - 1) {
    print '<tr><td colspan="8" align="right">';
    my $new_pos = $start + $count;
    print "<a href='/action/search?${date_bits}terms=$terms&pos=$new_pos''>More &gt;&gt;&gt;</a>\n";
  }
</%perl>
  </table>
</fieldset>

<br/>
Add tags to selected: <input name="tags" size="50"/> <input type="submit" name="submit" value="add" />

</form>
%# <script>
%# function myCallBackFunc( element, isSelected ){
%# element.style.backgroundColor = isSelected ? "#ee4" : "";
%# element.getElementsByTagName("input")[0].checked = isSelected;
%# }
%# //root element, childNode nodeType, callback function
%# mySelectables = new drag_select( "selectables_container", "TD", myCallBackFunc
%# );
%# </script>
%# 
% } else {
<p> No files found matching the tags: <% $terms %></p>
% }

% # print $c->response->body(Data::Dumper->Dump([$c]));

